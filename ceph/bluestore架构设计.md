# bluestore架构设计

## 前言
ceph早期的单机对象存储引擎是 **FileStore** ，为维护数据的一致性，写入之前数据会先写入 **Journal** ，然后在写到文件系统，会有一倍的写放大，而同时现在的文件系统一般是日志型文件系统（ext系列、xfs），文件系统本身为了数据一致性，也会写 **Journal** ，此时相当于先维护了两份 **Journal**；另外 **FileStore** 是针对 **HDD** 的，并没有对 **SSD** 做优化，随着 **SSD** 的普及，针对 **SSD** 优化的单机对象存储也被提上日程，**BlueStore** 便应运而生。

## 设计理念

**存储系统中，数据可靠性是至关重要的。** 所有的读操作都是同步的，即除非命中缓存，否则必须从磁盘中读到指定的内容才能返回。写操作则不一样，为了性能的考虑，所有写操作都会预先在内存中进行缓存，有文件系统进行合适的组织后，再批量写到磁盘中。但由于内存数据在掉电后会丢失，因此，出于数据可靠性考虑，我们无法这么做。

**一种可行的替代方案便是将数据先写入相较不同磁盘性能更好的非易失性介质（SSD、NVME等** ，然后再将数据写入内存缓存，便可返回客户端成功，等数据写入普通磁盘后再释放中间设备相应的空间。 **这个写中间设备的过渡过程成为写日志，中间设备相应的被成为日志设备。** 如果写日志过程失败，直接返回失败即可。如果数据写入日志完成，在写入普通盘的过程中掉电，系统重新上电后也可以通过日志数据重新进行数据恢复。 **大型生产环境中一般用SSD或NVME做日志盘，HDD做普通数据盘。**

**除了数据可靠性之外，存储系统还要考虑数据一致性。** 涉及数据修改的操作，要么完全完成，要么数据没有变化，而不能是介于两者之间的中间状态。符合上述语义的存储系统也称为事务型存储系统，其最大的特点是所有操作都符合事务的ACID语义。**ACID ，是保证事务正确执行的四个基本要素的缩写，即原子性（Atomicity）、一致性（Consistency）、隔离性（Isolation）、持久性（Durability）。**

**BlueStore便是一个事务型的本地日志文件系统** 。因为面向下一代全闪存阵列的设计，所以BlueStore在保证数据可靠性和一致性的前提下，需要尽可能的减小日志系统中双写带来的影响。全闪存阵列的存储介质的主要开销不再是磁盘寻址时间，而是数据传输时间。因此当一次写入的数据量超过一定规模后，写入Journal盘(SSD)的延时和直接写入数据盘(SSD)的延迟不再有明显优势，所以Journal的存在性便大大减弱了。但是要保证OverWrite(覆盖写)的数据一致性，又不得不借助于Journal，所以针对Journal设计的考量便变得尤为重要了。

一个可行的方式是使用增量日志。针对大范围的覆盖写，只在其前后非磁盘块大小对齐的部分使用Journal，即RMW，其他部分直接重定向写COW即可。

**BlockSize** ：磁盘IO操作的最小单元(原子操作)。HDD为512B，SSD为4K。即读写的数据就算少于BlockSize，磁盘IO的大小也是BlockSize，是原子操作，要么写入成功，要么写入失败，即使掉电不会存在部分写入的情况。

**RMW(Read-Modify-Write)** ：指当覆盖写发生时，如果本次改写的内容不足一个BlockSize，那么需要先将对应的块读上来，然后再内存中将原内容和待修改内容合并Merge，最后将新的块写到原来的位置。但是RMW也带来了两个问题：一是需要额外的读开销；二是RMW不是原子操作，如果磁盘中途掉电，会有数据损坏的风险。为此我们需要引入Journal，先将待更新数据写入Journal，然后再更新数据，最后再删除Journal对应的空间。

**COW(Copy-On-Write)** ：指当覆盖写发生时，不是更新磁盘对应位置已有的内容，而是新分配一块空间，写入本次更新的内容，然后更新对应的地址指针，最后释放原有数据对应的磁盘空间。理论上COW可以解决RMW的两个问题，但是也带来了其他的问题：一是COW机制破坏了数据在磁盘分布的物理连续性。经过多次COW后，读数据的顺序读将会便会随机读。二是针对小于块大小的覆盖写采用COW会得不偿失。是因为：一是将新的内容写入新的块后，原有的块仍然保留部分有效内容，不能释放无效空间，而且再次读的时候需要将两个块读出来做Merge操作，才能返回最终需要的数据，将大大影响读性能。二是存储系统一般元数据越多，功能越丰富，元数据越少，功能越简单。而且任何操作必然涉及元数据，所以元数据是系统中的热点数据。COW涉及空间重分配和地址重定向，将会引入更多的元数据，进而导致系统元数据无法全部缓存在内存里面，性能会大打折扣。

基于以上设计理念，**BlueStore的写策略综合运用了COW和RMW策略。非覆盖写直接分配空间写入即可；块大小对齐的覆盖写采用COW策略；小于块大小的覆盖写采用RMW策略** 。

## 整体架构图
BlueStore架构图
![BlueStore架构图](../workspace/img/BlueStoreArch.png "BlueStore架构图") 

### 核心模块

>- BlockDevice：物理块设备，使用Libaio操作裸设备，AsyncIO。
>- BlueFS：小型的Append文件系统，实现了RocksDB::Env接口，给RocksDB用。
>- BlueRocksEnv：抛弃了传统文件系统，封装RocksDB文件操作的接口。
>- RocksDB：存储WAL、对象元数据、对象扩展属性Omap、磁盘分配器元数据。
>- Allocator：磁盘分配器，负责高效的分配磁盘空间。

